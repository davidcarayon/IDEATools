---
title: "Diagnostic IDEA4"
date: "`r format(Sys.Date(), '%d %B %Y')`"
output:
  pdf_document:
    highlight: zenburn
    latex_engine: xelatex
    number_sections: yes
    toc: yes
    toc_depth: 3
    keep_tex: true
fontsize: 13pt
header-includes:
- \usepackage[french]{babel}
- \usepackage{lastpage}
- \usepackage{float}
- \usepackage{graphicx}
- \usepackage{caption}
- \usepackage{tocloft}
- \renewcommand\cftsecfont{\Large}
- \renewcommand\cftsubsecfont{\large}
- \renewcommand\cftsubsubsecfont{\large}
- \renewcommand\cftsecpagefont{\Large}
- \captionsetup[figure]{font=large}
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyfoot[C]{Diagnostic IDEA4 - `r format(Sys.Date(), "%d %B %Y")`}
- \fancyfoot[R]{Page \thepage / \pageref{LastPage}}
mainfont: Carlito
subtitle: Eléments de sortie d'analyse individuelle - Version 0.1
params:
  outdir : "tmp"
  file : "file"
  anon : FALSE
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, out.width = "100%", fig.pos = "H")
options(shiny.maxRequestSize=30*1024^2)
library(dplyr)
library(tidyr)
library(ggplot2)
library(here)
library(IDEATools)
library(glue)
library(readr)
library(stringr)
```


```{r input, include = FALSE}
outdir <- params$outdir
file = params$file
anon = params$anon
```


```{r calcul IDEA, include = FALSE}
IDEAdata <- IDEATools::importIDEA(file, anonymous = FALSE)
IDEAresdim <- IDEATools::dimensionsPlots(IDEAdata)
IDEAresprop <- IDEATools::MakeTrees(IDEAdata)
IDEATools::exportIDEA(IDEAresdim,outdir = outdir)

res_prop <- IDEAdata$dataset
res_dim <- IDEAdata$dataset
metadata <- IDEAdata$metadata
nodes <- IDEAdata$nodes

```


```{r results = "asis"}
nom_files <- nodes$Global$nom_exploit[[1]]
cat(paste0("\\fancyfoot[L]{Exploitation : ",nom_files,"}"))
```

\vspace{+3cm}
\Large

```{r}
if (anon == FALSE) {
  
  names(metadata) = c("nom","A", "B")
  
  metadata <- metadata %>% filter(A %in% c("NOM Prénom :","Département :","Type d'exploitation :","Forme sociétaire :","SAU (hors forêt) :")) %>% 
    mutate(B = ifelse(A == "SAU (hors forêt) :", yes = round(as.numeric(B)) %>% as.character(), no = B))

  names(metadata) = c(" ", "  ","   ")
  knitr::kable(metadata[,2:3])
  
  }
```

\newpage

# Lecture par les dimensions

## Résultats pour les dimensions

\Large

```{r}
min_val <- min(res_dim$score_dim)
```

La note d'IDEA4 obtenue pour cette exploitation est de **`r min_val` / 100**.

\large

```{r fig.width = 9.11, fig.height=5.6}
print(IDEAresdim[[1]]$dimensions)
```

## Résultats pour les composantes

```{r fig.cap= "Composantes", fig.width = 13.69, fig.height=10.5}
print(IDEAresdim[[1]]$composantes)
```

## Résultats pour les indicateurs

### Indicateurs AgroEcologiques

```{r fig.cap= "Indicateurs AgroEcologiques", fig.width = 10.69, fig.height=12}
print(IDEAresdim[[1]]$indic_Agroécologique+ theme(panel.spacing = unit(1, "lines")))
```

### Indicateurs Socio-Territoriaux

```{r fig.cap= "Indicateurs socio-territoriaux", fig.width = 10.69, fig.height=13.5}
print(IDEAresdim[[1]]$`indic_Socio-Territoriale`+ theme(panel.spacing = unit(1, "lines")))
```

### Indicateurs Economiques

```{r fig.cap= "Indicateurs Economiques", fig.width = 10.69, fig.height=9}
print(IDEAresdim[[1]]$indic_Economique + theme(panel.spacing = unit(1, "lines"))) 
```

\hbox{}

# Lecture par les propriétés

## Arbres éclairé des propriétés

```{r}
v <- nodes$Global$nom_exploit[[1]] %>% stringr::str_replace_all(" ","_")
```

\rotatebox{270}{

\begin{minipage}{0.85\textheight}


```{r fig.cap= "Ancrage territorial"}
knitr::include_graphics(file.path(outdir,v,"Propriétés","Cartes_heuristiques","Ancrage.pdf"))
```

\end{minipage}}

\rotatebox{270}{
\begin{minipage}{\textheight}
```{r fig.cap= "Autonomie"}
knitr::include_graphics(file.path(outdir,v,"Propriétés","Cartes_heuristiques","Autonomie.pdf"))
```
\end{minipage}}

\rotatebox{270}{
\begin{minipage}{\textheight}
```{r fig.cap= "Capacité productive et reproductive de biens et services"}
knitr::include_graphics(file.path(outdir,v,"Propriétés","Cartes_heuristiques","Capacité.pdf"))
```
\end{minipage}}

\rotatebox{270}{
\begin{minipage}{\textheight}
```{r fig.cap= "Responsabilité globale"}
knitr::include_graphics(file.path(outdir,v,"Propriétés","Cartes_heuristiques","Responsabilité.pdf"))
```
\end{minipage}}

\rotatebox{270}{
\begin{minipage}{\textheight}
```{r fig.cap= "Robustesse"}
knitr::include_graphics(file.path(outdir,v,"Propriétés","Cartes_heuristiques","Robustesse.pdf"))
```
\end{minipage}}

\rotatebox{270}{
\begin{minipage}{\textheight}
```{r fig.cap= "Vision globale de la lecture par les propriétés"}
knitr::include_graphics(file.path(outdir,v,"Propriétés","Cartes_heuristiques","Global.pdf"))
```
\end{minipage}}

## Diagamme radar des scores obtenus au sein de chaque propriété

```{r} 
indicateurs_ancrage <- c("B10","B3","B9","B8","B7","B6","B15","B14","B19")
indicateurs_autonomie <- c("B13","B15","B18","B8","C5","C3","C6","A7","A8","A6")
indicateurs_robustesse <- c("A1","A3","A4","A14","C5","C4","C7","A2","C8","C9","A15","B22","B13","B15","B18","B16")
indicateurs_responsabilite <- c("B20","B5","B19","B11","B1","B2","B4","A10","A9","A11","C11","B17","B14","B16","B21","B23","A5","A16","A17","A18","A19","B12")
indicateurs_capacite <- c("A5","A12","A13","B14","B15","B16","B13","B18","B1","B3","C1","C2","C3","C10")

prop_radar <- res_dim %>% 
  dplyr::mutate(Propriete = dplyr::case_when(indicateur %in% indicateurs_ancrage ~ "Ancrage Territorial",
                               indicateur %in% indicateurs_autonomie ~ "Autonomie",
                               indicateur %in% indicateurs_robustesse ~ "Robustesse",
                               indicateur %in% indicateurs_responsabilite ~ "Responsabilité globale",
                               indicateur %in% indicateurs_capacite ~ "Capacité productive et reproductive \nde biens et de services"))  %>% 
  dplyr::mutate(dimension = stringr::str_remove_all(dimension,"Durabilité ")) %>% 
  dplyr::mutate(num_indic = readr::parse_number(indicateur)) %>% 
  dplyr::arrange(dplyr::desc(dimension),num_indic) %>% 
  dplyr::mutate(indicateur = factor(indicateur, levels = unique(indicateur)))

plist <- list()

for (i in unique(prop_radar$Propriete)) {
  
# Get the name and the y position of each label
label_data <- prop_radar %>% dplyr::filter(Propriete == i)
label_data$id <- seq(1, nrow(label_data))
number_of_bar <- nrow(label_data)
angle <- 90 - 360 * (label_data$id-0.5) /number_of_bar     # I substract 0.5 because the letter must have the angle of the center of the bars. Not extreme right(1) or extreme left (0)
label_data$hjust <- ifelse( angle < -90, 1, 0)
label_data$angle <- ifelse(angle < -90, angle+180, angle)
label_data = label_data %>% dplyr::filter(score_ind > 5)
  
plist[[i]] <- ggplot2::ggplot(prop_radar %>% dplyr::filter(Propriete == i), ggplot2::aes(x = indicateur, y = score_ind, fill = dimension)) +
  ggplot2::geom_rect(xmin = -Inf, ymin = -20, xmax = Inf, ymax = 100, fill = "white", color = "white")+
  ggplot2::geom_col(ggplot2::aes(x = indicateur, y = 100, fill = dimension),alpha = 0.3, color = "black")+
  ggplot2::geom_col() +
  ggplot2::theme_bw()+
  ggplot2::geom_text(data=label_data, ggplot2::aes(x=id, y=score_ind+1, label=paste0(round(score_ind),"%"), hjust=hjust), color="black", fontface="bold",alpha=1, size=4.2, angle= label_data$angle, inherit.aes = FALSE) +
    # ggplot2::geom_hline(yintercept = c(100), color = "black", size = 1.5, linetype = 1)+
  ggplot2::scale_fill_manual(limits = c("Agroécologique","Socio-Territoriale","Economique"),values = c("Agroécologique" = "#2e9c15", "Socio-Territoriale" = "#5077FE", "Economique" = "#FE962B")) +
  ggplot2::theme(
    axis.title = ggplot2::element_blank(),
    plot.title = ggplot2::element_text(size = 15,hjust = 0.5, face = "bold"),
    legend.text = ggplot2::element_text(size = 13),
    legend.title = ggplot2::element_text(size = 15),
    axis.text.y = ggplot2::element_blank(),
    axis.ticks.y = ggplot2::element_blank(),
    panel.grid.major.y = ggplot2::element_blank()
    
  ) +
  ggplot2::scale_y_continuous(limits = c(-20,130),breaks = c(0,20,40,60,80,100))+
  ggplot2::theme(axis.text = ggplot2::element_text(size = 13, color = "black", face = "bold"))  +
  ggplot2::labs(fill = "Dimension", title = glue::glue('Indicateurs de la propriété "{i}"'), caption = "NB : Les scores inférieurs à 5% ne sont pas indiqués")+
  ggplot2::theme(legend.position = "top")+
  ggplot2::coord_polar() 
}

```

```{r fig.cap= "Pourcentage du score maximal obtenu pour chaque indicateur rattaché à la propriété Angrage territorial", fig.width = 6, fig.height=7, fig.align="center"}
print(plist[["Ancrage Territorial"]])
```

```{r fig.cap= "Pourcentage du score maximal obtenu pour chaque indicateur rattaché à la propriété Autonomie", fig.width = 6, fig.height=7, fig.align="center"}
print(plist[["Autonomie"]])
```

```{r fig.cap= "Pourcentage du score maximal obtenu pour chaque indicateur rattaché à la propriété Capacité productive et reproductive de biens et services", fig.width = 6, fig.height=7, fig.align="center"}
print(plist[["Capacité productive et reproductive \nde biens et de services"]])
```

```{r fig.cap= "Pourcentage du score maximal obtenu pour chaque indicateur rattaché à la propriété Responsabilité globale", fig.width = 6, fig.height=7, fig.align="center"}
print(plist[["Responsabilité globale"]])
```

```{r fig.cap= "Pourcentage du score maximal obtenu pour chaque indicateur rattaché à la propriété Robustesse", fig.width = 6, fig.height=7, fig.align="center"}
print(plist[["Robustesse"]])
```


\newpage

# Légende

\footnotesize

```{r}
label_nodes %>% select(`Code Indicateur`=code_indicateur, `Nom Indicateur`=nom_indicateur, Niveau = level, Dimension = dimension, Composante = composante, dim) %>%
  mutate(no_code = parse_number(`Code Indicateur`)) %>%
  mutate(Niveau = factor(Niveau, levels = c("indicateur","noeud","branche","propriete"))) %>%
  arrange(Niveau,dim,no_code) %>%
  mutate(Dimension = as.character(Dimension)) %>%
  select(-dim, -no_code) %>%
  mutate(Composante = str_remove_all(Composante,"\\n")) %>%
  select(-Composante) %>%
  mutate(Dimension =ifelse(is.na(Dimension),yes = " ",no = Dimension)) %>%
  filter(Niveau == "indicateur") %>%
  select(-Niveau) %>%
  knitr::kable()
```
