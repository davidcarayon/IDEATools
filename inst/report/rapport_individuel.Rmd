---
title: "Diagnostic IDEA4"
date: "Analyse du `r format(Sys.Date(), '%d %B %Y')`"
output:
  pdf_document:
    highlight: zenburn
    latex_engine: xelatex
    number_sections: yes
    toc: yes
    toc_depth: 3
    keep_tex: false
header-includes:
- \usepackage[french]{babel}
- \usepackage{lastpage}
- \usepackage{float}
- \usepackage{graphicx}
- \usepackage{caption}
- \usepackage{tocloft}
- \renewcommand\cftsecfont{\Large}
- \renewcommand\cftsubsecfont{\large}
- \renewcommand\cftsubsubsecfont{\large}
- \renewcommand\cftsecpagefont{\Large}
- \captionsetup[figure]{font=large}
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyfoot[C]{Diagnostic IDEA4 - `r format(Sys.Date(), "%d %B %Y")`}
- \fancyfoot[R]{Page \thepage / \pageref{LastPage}}
mainfont: Rubik
subtitle: Eléments de sortie d'analyse individuelle - Version 1.0
params:
  outdir : "tmp"
  data: "data"
  anon : FALSE
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, out.width = "100%", fig.pos = "H")
options(shiny.maxRequestSize=30*1024^2)
```


```{r ressources}
## Légende associée aux métadonnées du fichier .json
MTD_legende <- tibble::tribble(
  ~code,                                   ~nom,                                                      ~etendue,
  "MTD_00",      "Version du calculateur utilisée",                                                    "Alpha 10",
  "MTD_01",             "Identifiant exploitation",                                                       "Num 6",
  "MTD_02",                                  "SAU",                                           "0 à 10 000 (2 dc)",
  "MTD_03",                                  "UTH",                                           "0 à 10 000 (2 dc)",
  "MTD_04",                                "UTH F",                                              "0 à 100 (2 dc)",
  "MTD_05", "Tranche d’âge du chef d’exploitation", "«-25»,«25-35»,«35-45», «45-55»,«55-65» et «65+»",
  "MTD_06",      "Typologie d'exploitation (OTEX)",                                       "Codes OTEX simplifiés",
  "MTD_07",      "Surface en herbe en % de la SAU",                                              "0 à 100 (2 dc)",
  "MTD_08",               "Capital d’exploitation",                                             "0 à 100000 000",
  "MTD_09",                                  "EBE",                                    "– 1000 000 à 10000 000",
  "MTD_10",                     "Résultat courant",                                    "– 1000 000 à 10000 000",
  "MTD_11",      "Zone géographique (département)",                                      "liste des départements",
  "MTD_12",         "Atelier hors sol: oui / non",                                                      "0 ou 1",
  "MTD_13",                      "Année d'enquête",                                                       "Num 4",
  "MTD_14",                       "Type d’élevage",       "0 - pas d’élevage / 1 – monogastrique / 2 - herbivore",
  "MTD_15",              "Part des PP dans la SAU",                                              "0 à 100 (2 dc)",
  "MTD_16", "Usage des produits phytos: oui /non",                                                      "0 ou 1"
)

```


```{r input, include = FALSE}
outdir <- params$outdir
IDEAdata = params$data
anon = params$anon
```


```{r calcul IDEA, include = FALSE}
IDEAresdim <- IDEATools::dimensionsPlots(IDEAdata)
IDEAresrad <- IDEATools::radarPlots(IDEAdata)

res_prop <- IDEAdata$dataset
res_dim <- IDEAdata$dataset
metadata <- IDEAdata$metadata
nodes <- IDEAdata$nodes

v <- metadata$MTD_01 %>% stringr::str_replace_all(" ","_")

ff <- file.path(outdir,v,"Propriétés","Arbres_éclairés",paste0(v,"_","Ancrage Territorial.pdf"))
file.rename(from = ff, to = file.path(outdir,v,"Propriétés","Arbres_éclairés",paste0(v,"_","Ancrage.pdf")))

ff <- file.path(outdir,v,"Propriétés","Arbres_éclairés",paste0(v,"_","Capacité productive et reproductive de biens et de services.pdf"))
file.rename(from = ff, to = file.path(outdir,v,"Propriétés","Arbres_éclairés",paste0(v,"_","CAP.pdf")))

ff <- file.path(outdir,v,"Propriétés","Arbres_éclairés",paste0(v,"_","Responsabilité globale.pdf"))
file.rename(from = ff, to = file.path(outdir,v,"Propriétés","Arbres_éclairés",paste0(v,"_","RESP.pdf")))

```


```{r results = "asis"}
nom_files <- metadata$MTD_01
cat(paste0("\\fancyfoot[L]{Exploitation : ",nom_files,"}"))
```

\vspace{5mm}

```{r}

if (anon == FALSE) {
  
tab <- metadata %>% tidyr::gather(key = code, value = valeur) %>% dplyr::inner_join(MTD_legende, by ="code") %>% dplyr::select(`Métadonnée` = nom, Valeur = valeur) %>% rowwise() %>% mutate(Valeur = tidyr::replace_na(Valeur, "Iconnu(e)")) %>% ungroup()
  
  }
```


```{r}
tab %>% dplyr::slice(-13,-15) %>% 
  knitr::kable()
```

```{r}
knitr::include_graphics("bandeau.png", auto_pdf = TRUE)
```

\newpage

# Lecture par les dimensions

## Résultats pour les dimensions

\large

```{r}
min_val <- min(res_dim$dimension_value)
```

La note d'IDEA4 obtenue pour cette exploitation est de **`r min_val` / 100**.

<br>

\large

```{r fig.width = 9.11, fig.height=5.6}
print(IDEAresdim[[1]]$dimensions)
```

## Résultats pour les composantes

```{r fig.cap= "Scores obtenus pour chaque composante de la durabilité", fig.width = 13.69, fig.height=10.5}
print(IDEAresdim[[1]]$composantes)
```

## Résultats pour les indicateurs

### Indicateurs Agroécologiques

```{r fig.cap= "Scores obtenus pour les indicateurs Agroécologiques, regroupés par composante", fig.width = 10.69, fig.height=12}
print(IDEAresdim[[1]]$indic_Agroécologique+ ggplot2::theme(panel.spacing = ggplot2::unit(1, "lines")))
```

\let\cleardoublepage\clearpage

### Indicateurs Socio-Territoriaux

```{r fig.cap= "Scores obtenus pour les indicateurs Socio-territoriaux, regroupés par composante", fig.width = 10.69, fig.height=12.5}
print(IDEAresdim[[1]]$`indic_Socio-Territoriale`+ ggplot2::theme(panel.spacing = ggplot2::unit(1, "lines")))
```

### Indicateurs Economiques

```{r fig.cap= "Scores obtenus pour les indicateurs Economiques, regroupés par composante", fig.width = 10.69, fig.height=9}
print(IDEAresdim[[1]]$indic_Economique + ggplot2::theme(panel.spacing = ggplot2::unit(1, "lines"))) 
```

\hbox{}

# Lecture par les propriétés

## Arbres éclairés des propriétés

```{r}
v <- metadata$MTD_01 %>% stringr::str_replace_all(" ","_")
```

\center

\rotatebox{270}{

\begin{minipage}{0.85\textheight}


```{r fig.cap= 'Arbre éclairé de la propriété "Ancrage territorial"'}

knitr::include_graphics(file.path(outdir,v,"Propriétés","Arbres_éclairés",paste0(v,"_","Ancrage.pdf")), auto_pdf = TRUE)
```

\end{minipage}}

\rotatebox{270}{
\begin{minipage}{\textheight}
```{r fig.cap= 'Arbre éclairé de la propriété "Autonomie"'}
knitr::include_graphics(file.path(outdir,v,"Propriétés","Arbres_éclairés",paste0(v,"_","Autonomie.pdf")))
```
\end{minipage}}

\rotatebox{270}{
\begin{minipage}{\textheight}
```{r fig.cap= 'Arbre éclairé de la propriété "Capacité productive et reproductive de biens et services"'}
knitr::include_graphics(file.path(outdir,v,"Propriétés","Arbres_éclairés",paste0(v,"_","CAP.pdf")), auto_pdf = TRUE)
```
\end{minipage}}

\rotatebox{270}{
\begin{minipage}{\textheight}
```{r fig.cap= 'Arbre éclairé de la propriété "Responsabilité globale"'}
knitr::include_graphics(file.path(outdir,v,"Propriétés","Arbres_éclairés",paste0(v,"_","RESP.pdf")))
```
\end{minipage}}

\rotatebox{270}{
\begin{minipage}{\textheight}
```{r fig.cap= 'Arbre éclairé de la propriété "Robustesse"'}
knitr::include_graphics(file.path(outdir,v,"Propriétés","Arbres_éclairés",paste0(v,"_","Robustesse.pdf")), auto_pdf = TRUE)
```
\end{minipage}}

\rotatebox{270}{
\begin{minipage}{\textheight}
```{r fig.cap= 'Arbre éclairé global de la lecture par les propriétés'}
knitr::include_graphics(file.path(outdir,v,"Propriétés","Arbres_éclairés",paste0(v,"_","Global.pdf")))
```
\end{minipage}}

\rotatebox{270}{
\begin{minipage}{\textheight}
```{r fig.cap= "Synthèse de la lecture par les propriétés avec un focus sur les premières branches d'agrégation"}
knitr::include_graphics(file.path(outdir,v,"Propriétés","Arbres_éclairés",paste0(v,"_","Global_zoom.pdf")))
```
\end{minipage}}

## Diagamme radar des scores obtenus au sein de chaque propriété

```{r} 
plist <- IDEAresrad[[1]]
```

```{r fig.cap= 'Pourcentage du score maximal obtenu pour chaque indicateur rattaché à la propriété "Angrage territorial"', fig.width = 16.1, fig.height=7.61, fig.align="center"}
print(plist[["Ancrage Territorial"]])
```

```{r fig.cap= 'Pourcentage du score maximal obtenu pour chaque indicateur rattaché à la propriété "Autonomie"', fig.width = 16.1, fig.height=7.61, fig.align="center"}
print(plist[["Autonomie"]])
```

```{r fig.cap= 'Pourcentage du score maximal obtenu pour chaque indicateur rattaché à la propriété "Capacité productive et reproductive de biens et services"', fig.width = 16.1, fig.height=7.61, fig.align="center"}
print(plist[["Capacité productive et reproductive \nde biens et de services"]])
```

```{r fig.cap= 'Pourcentage du score maximal obtenu pour chaque indicateur rattaché à la propriété "Responsabilité globale"', fig.width = 16.1, fig.height=7.61, fig.align="center"}
print(plist[["Responsabilité globale"]])
```

```{r fig.cap= 'Pourcentage du score maximal obtenu pour chaque indicateur rattaché à la propriété "Robustesse"', fig.width = 16.1, fig.height=7.61, fig.align="center"}
print(plist[["Robustesse"]])
```

